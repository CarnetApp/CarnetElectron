<!DOCTYPE html>
<html>

<head>

    <script>
        window.jQuery = window.$ = require('jquery');
    </script>
    <link rel="stylesheet" href="browsers/design.css">
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <!-- Material Design icon font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>

<body>



    <webview src="browsers/index.html" id="browser-webview" style="position:fixed; top:0px; left:0px;height:100%; width:100%; z-index:100; right:0; bottom:0;"
        nodeintegration>
    </webview>
    <webview id="writer-webview" style="position:fixed; top:0px; left:0px;display:none; height:100%; width:100%; z-index:100; right:0; bottom:0;"
        nodeintegration>
    </webview>
    <div id="loading-view" style="position:fixed; top:0px; display:none; left:0px;height:100%; width:100%; z-index:100; right:0; bottom:0; background:white;">
        <div class="mdl-spinner mdl-js-spinner is-active" style="position:absolute; top:50%; margin-top:-150px; left:50%; margin-left:-150px;width:300px; height:300px;"></div>
    </div>
    <script>
        var hasLoadedOnce = false;
        var loadingView = document.getElementById("loading-view")

        var webview = document.getElementById("writer-webview")
        var browserWebview = document.getElementById("browser-webview")

        loadingView = document.getElementById("loading-view")

        webview.addEventListener('dom-ready', () => {
            //webview.openDevTools()
        })
        browserWebview.addEventListener('ipc-message', event => {
            if (event.channel == "openNote") {
                $(loadingView).fadeIn();
                console.log("open note " + event.args[0])
                setTimeout(function () {
                    if (!hasLoadedOnce || true) {
                        const path = require('path')

                        webview.setAttribute("src", path.join(__dirname, 'tmp/reader.html?path=' +
                            encodeURIComponent(event.args[0])));
                        hasLoadedOnce = true;
                    } else {
                        webview.send('loadnote', event.args[0]);
                    }
                    $(webview).show();
                }, 500); //to let loading appear
            }
        })

        webview.addEventListener('ipc-message', event => {
            if (event.channel == "exit") {
                $(webview).hide();
            } else if (event.channel == "loaded") {
                $(loadingView).fadeOut();
            }
        });

        var main = require("./main.js")
        main.setMergeListener(function () {
            list(initPath, true)
        })
    </script>
</body>

</html>